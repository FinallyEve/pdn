#pragma once

#include "state/state.hpp"
#include "utils/simple-timer.hpp"
#include "game/base-states/base-intro-state.hpp"
#include "game/base-states/base-win-state.hpp"
#include "game/base-states/base-lose-state.hpp"

class ExploitSequencer;

/*
 * Exploit Sequencer state IDs — offset to 600+ to avoid collisions.
 */
enum ExploitSequencerStateId {
    EXPLOIT_INTRO    = 600,
    EXPLOIT_WIN      = 601,
    EXPLOIT_LOSE     = 602,
    EXPLOIT_SHOW     = 603,
    EXPLOIT_GAMEPLAY = 604,
    EXPLOIT_EVALUATE = 605,
};

/*
 * ExploitSequencerIntro — Title screen. Shows "EXPLOIT SEQUENCER" and subtitle.
 * Resets session and seeds RNG. Transitions to Show after timer.
 */
class ExploitSequencerIntro : public BaseIntroState<ExploitSequencer, EXPLOIT_SHOW> {
public:
    explicit ExploitSequencerIntro(ExploitSequencer* game);

    bool transitionToShow() const { return this->transitionCondition(); }

protected:
    const char* introTitle() const override { return "EXPLOIT SEQUENCER"; }
    const char* introSubtext() const override { return "Inject the code."; }
    LEDState getIdleLedState() const override;
    AnimationConfig getIntroAnimationConfig() const override;
};

/*
 * ExploitSequencerShow — Pre-exploit briefing screen.
 * Displays sequence/exploit counters and fails remaining.
 * Resets symbolPosition and playerPressed for the next exploit.
 * Transitions to Gameplay after a short delay.
 */
class ExploitSequencerShow : public State {
public:
    explicit ExploitSequencerShow(ExploitSequencer* game);
    ~ExploitSequencerShow() override;

    void onStateMounted(Device* PDN) override;
    void onStateLoop(Device* PDN) override;
    void onStateDismounted(Device* PDN) override;
    bool transitionToGameplay();

private:
    ExploitSequencer* game;
    SimpleTimer showTimer;
    static constexpr int SHOW_DURATION_MS = 1500;
    bool transitionToGameplayState = false;
};

/*
 * ExploitSequencerGameplay — Core QTE state.
 * Symbol scrolls from position 0 to scrollLength on a timer.
 * Player presses PRIMARY to attempt the exploit.
 * Transitions to Evaluate when player presses or symbol reaches end.
 */
class ExploitSequencerGameplay : public State {
public:
    explicit ExploitSequencerGameplay(ExploitSequencer* game);
    ~ExploitSequencerGameplay() override;

    void onStateMounted(Device* PDN) override;
    void onStateLoop(Device* PDN) override;
    void onStateDismounted(Device* PDN) override;
    bool transitionToEvaluate();

    ExploitSequencer* game;

private:
    SimpleTimer scrollTimer;
    bool transitionToEvaluateState = false;
};

/*
 * ExploitSequencerEvaluate — Checks exploit result.
 * Hit: symbolPosition within markerPosition +/- timingWindow -> score += 100
 * Miss: outside window or timeout -> fails++
 * Routes to: Show (next exploit), Win (all complete), or Lose (too many fails).
 */
class ExploitSequencerEvaluate : public State {
public:
    explicit ExploitSequencerEvaluate(ExploitSequencer* game);
    ~ExploitSequencerEvaluate() override;

    void onStateMounted(Device* PDN) override;
    void onStateLoop(Device* PDN) override;
    void onStateDismounted(Device* PDN) override;
    bool transitionToShow();
    bool transitionToWin();
    bool transitionToLose();

private:
    ExploitSequencer* game;
    bool transitionToShowState = false;
    bool transitionToWinState = false;
    bool transitionToLoseState = false;
};

/*
 * ExploitSequencerWin — Victory screen. Shows "EXPLOIT DONE".
 * Sets outcome to WON. In standalone mode, transitions back to Intro.
 * In managed mode, calls Device::returnToPreviousApp().
 */
class ExploitSequencerWin : public BaseWinState<ExploitSequencer, EXPLOIT_INTRO> {
public:
    explicit ExploitSequencerWin(ExploitSequencer* game);

protected:
    const char* victoryText() const override { return "EXPLOIT DONE"; }
    LEDState getWinLedState() const override;
    bool computeHardMode() const override;

    void logVictory(int score, bool isHard) const override;
};

/*
 * ExploitSequencerLose — Defeat screen. Shows "EXPLOIT FAILED".
 * Sets outcome to LOST. In standalone mode, transitions back to Intro.
 * In managed mode, calls Device::returnToPreviousApp().
 */
class ExploitSequencerLose : public BaseLoseState<ExploitSequencer, EXPLOIT_INTRO> {
public:
    explicit ExploitSequencerLose(ExploitSequencer* game);

    void onStateMounted(Device* PDN) override;

protected:
    const char* defeatText() const override { return "EXPLOIT FAILED"; }
    LEDState getLoseLedState() const override;
    bool showScoreOnLose() const override { return true; }
    int getDefeatTextY() const override { return 25; }
    AnimationConfig getLoseAnimationConfig() const override;

    void logDefeat(int score) const override;
};
