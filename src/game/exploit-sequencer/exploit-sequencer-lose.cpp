#include "game/exploit-sequencer/exploit-sequencer-states.hpp"
#include "game/exploit-sequencer/exploit-sequencer.hpp"
#include "game/exploit-sequencer/exploit-sequencer-resources.hpp"
#include "device/drivers/logger.hpp"

static const char* TAG = "ExploitSeqLose";

ExploitSequencerLose::ExploitSequencerLose(ExploitSequencer* game) :
    BaseLoseState<ExploitSequencer, EXPLOIT_INTRO>(game, EXPLOIT_LOSE)
{
}

void ExploitSequencerLose::onStateMounted(Device* PDN) {
    // Compute hardMode before calling base implementation
    auto& config = game->getConfig();
    bool hardMode = (config.timingWindow <= 6 && config.failsAllowed <= 1);

    // Call base implementation
    BaseLoseState<ExploitSequencer, EXPLOIT_INTRO>::onStateMounted(PDN);

    // Override the outcome to set correct hardMode value
    auto& session = game->getSession();
    MiniGameOutcome loseOutcome;
    loseOutcome.result = MiniGameResult::LOST;
    loseOutcome.score = session.score;
    loseOutcome.hardMode = hardMode;
    game->setOutcome(loseOutcome);
}

LEDState ExploitSequencerLose::getLoseLedState() const {
    return EXPLOIT_SEQ_LOSE_STATE;
}

AnimationConfig ExploitSequencerLose::getLoseAnimationConfig() const {
    AnimationConfig config;
    config.type = AnimationType::IDLE;
    config.speed = 8;
    config.curve = EaseCurve::LINEAR;
    config.initialState = getLoseLedState();
    config.loopDelayMs = 0;
    config.loop = false;
    return config;
}

void ExploitSequencerLose::logDefeat(int score) const {
    auto& session = game->getSession();
    LOG_I(TAG, "EXPLOIT FAILED â€” score=%d, fails=%d", score, session.fails);
}
